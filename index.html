<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Identificados + Atribuciones</title>
  <style>
    :root{
      --bg: #f5f7fb;
      --panel: #ffffff;
      --text: #0b1220;
      --muted:#6b7280;
      --accent: #2563eb;
      --goodA: #22c55e; /* verde base */
      --goodB: #16a34a; /* verde oscuro */
      --badA:  #f87171; /* rojo base */
      --badB:  #ef4444; /* rojo oscuro */
      --needle:#111827;
      --ring:#e5e7eb;
      --shadow: 0 12px 32px rgba(0,0,0,.12);
    }
    [data-theme="dark"]{
      --bg: #0b1220;
      --panel: #0f172a;
      --text: #e5e7eb;
      --muted:#94a3b8;
      --accent: #60a5fa;
      --goodA: #34d399;
      --goodB: #16a34a;
      --badA:  #fca5a5;
      --badB:  #ef4444;
      --needle:#f3f4f6;
      --ring:#1f2937;
      --shadow: 0 12px 32px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif;background:var(--bg);color:var(--text);}

    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .board{background:var(--panel);border:1px solid var(--ring);border-radius:22px;box-shadow:var(--shadow);padding:20px}

    .topbar{display:flex;align-items:center;gap:12px;justify-content:flex-end;margin-bottom:10px}
    .switch{position:relative;width:54px;height:28px;background:var(--ring);border-radius:999px;cursor:pointer}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:var(--panel);box-shadow:0 2px 6px rgba(0,0,0,.25);transition:.2s}
    .switch.on{background:var(--accent)}
    .switch.on::after{left:29px}
    .muted{color:var(--muted)}

    .row{display:flex;gap:24px;flex-wrap:wrap;align-items:stretch}
    .gauge-card{flex:1 1 560px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center}
    .controls{flex:1 1 320px;display:flex;flex-direction:column;gap:14px}

    .field{display:flex;flex-direction:column;gap:8px}
    .label{display:flex;align-items:center;justify-content:space-between}
    .label b{font-weight:700}
    .field input[type="number"]{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--ring);background:transparent;color:var(--text);outline:0}
    button{appearance:none;border:0;padding:12px 16px;border-radius:14px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--ring)}

    .gauge{width:620px;max-width:100%}
    .gauge svg{display:block;width:100%;height:auto}
    .tick text{font-size:11px;fill:var(--muted)}

    #needle{transition: transform .45s cubic-bezier(.2,.8,.2,1)}
    #arcGreen,#arcRed{transition: stroke-dasharray .45s, stroke-dashoffset .45s}

    @media print{
      :root{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body{ background:#fff }
      .wrap{ margin:0; padding:0 }
      .board{ box-shadow:none; border-radius:0; border:0; padding:10mm }
      .controls{ display:none }
      @page{ size: Letter portrait; margin:10mm }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="board">
      <div class="topbar">
        <span class="muted">Día</span>
        <div id="themeSwitch" class="switch" role="button" aria-pressed="false" tabindex="0"></div>
        <span class="muted">Noche</span>
      </div>

      <div class="row">
        <section class="gauge-card">
          <div id="gaugeHost" class="gauge" aria-label="Indicador">
            <svg id="svgGauge" viewBox="0 0 220 140" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
              <defs>
                <linearGradient id="gradGreen" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--goodA)"/>
                  <stop offset="100%" stop-color="var(--goodB)"/>
                </linearGradient>
                <linearGradient id="gradRed" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--badA)"/>
                  <stop offset="100%" stop-color="var(--badB)"/>
                </linearGradient>
              </defs>

              <!-- Base exterior -->
              <path d="M14 120 A96 96 0 0 1 206 120" fill="none" stroke="rgba(0,0,0,.06)" stroke-width="18" stroke-linecap="butt"/>

              <!-- Trayectoria base 180° (para longitud) -->
              <path id="arcBase" d="M24 120 A86 86 0 0 1 196 120" fill="none" stroke-width="18" stroke-linecap="butt"/>
              <!-- Zonas -->
              <path id="arcGreen" d="M24 120 A86 86 0 0 1 196 120" fill="none" stroke-width="18" stroke-linecap="butt"/>
              <path id="arcRed"   d="M24 120 A86 86 0 0 1 196 120" fill="none" stroke-width="18" stroke-linecap="butt"/>

              <!-- Ticks 0..2459 -->
              <g id="ticks"></g>

              <!-- Aguja -->
              <g id="needle" transform="rotate(-90,110,120)">
                <line x1="110" y1="120" x2="110" y2="32" stroke="var(--needle)" stroke-width="3" />
                <circle cx="110" cy="120" r="6" fill="var(--needle)" />
              </g>

              <!-- Lectura principal = % Identificados/Atribuciones -->
              <text id="gaugeValue" x="110" y="108" text-anchor="middle" font-size="24" fill="var(--text)" font-weight="800">0.0</text>
              <text id="gaugeLabel" x="110" y="140" text-anchor="middle" font-size="10" fill="var(--muted)">% Identificados / Atribuciones</text>
            </svg>
          </div>
        </section>

        <section class="controls">
          <div class="field">
            <div class="label"><b>Identificados</b><span id="showIdent" class="muted">0 / 2459</span></div>
            <input id="ident" type="number" min="0" max="2459" step="1" placeholder="0-2459" value="0" />
          </div>
          <div class="field">
            <div class="label"><b>Atribuciones</b><span id="showAtrib" class="muted">0 / 2459</span></div>
            <input id="atrib" type="number" min="0" max="2459" step="1" placeholder="0-2459" value="0" />
          </div>
          <div class="row" style="gap:12px;align-items:center">
            <button id="btnAplicar">Aplicar</button>
            <button id="btnPDF" class="secondary" title="Exportar a PDF">Exportar PDF</button>
            <button id="btnPNG" class="secondary" title="Exportar PNG transparente (1280×720)">Exportar PNG</button>           
          </div>
          <div id="exportStatus" class="muted" style="min-height:1.5em;margin-top:6px"></div>
          <div id="downloadArea" style="margin-top:6px"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const MAX = 2459;

    // ===== Helpers =====
    const clamp = (n, min, max) => Math.min(Math.max(Number(n)||0, min), max);
    const pctIdentSobreAtrib = (i, a, cap100=true) => {
      const A = clamp(a,0,MAX), I = clamp(i,0,MAX);
      if(A === 0) return 0;
      const p = (I/A)*100; return cap100 ? Math.min(p,100) : p;
    };

    // ===== Tema Día/Noche =====
    const root = document.documentElement;
    const themeSwitch = document.getElementById('themeSwitch');
    function setTheme(mode){
      root.setAttribute('data-theme', mode);
      const on = mode === 'dark';
      themeSwitch.classList.toggle('on', on);
      themeSwitch.setAttribute('aria-pressed', String(on));
      try{localStorage.setItem('indicador-theme', mode)}catch(e){}
    }
    const savedTheme = (()=>{try{return localStorage.getItem('indicador-theme')}catch(e){return null}})();
    setTheme(savedTheme || 'light');
    const toggleTheme = ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');
    themeSwitch.addEventListener('click', toggleTheme);
    themeSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); toggleTheme();}});

    // ===== Construye ticks 0..MAX (11 marcas) =====
    const ticksG = document.getElementById('ticks');
    const steps = 10; // 0..10 -> 11 marcas
    for(let i=0;i<=steps;i++){
      const angle = -90 + (i*(180/steps)); // -90..90
      const len = i%5===0 ? 10 : 6;
      const r1 = 96, r2 = 96-len;
      const x1 = 110 + r1*Math.cos(angle*Math.PI/180);
      const y1 = 120 + r1*Math.sin(angle*Math.PI/180);
      const x2 = 110 + r2*Math.cos(angle*Math.PI/180);
      const y2 = 120 + r2*Math.sin(angle*Math.PI/180);
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','tick');
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',x1); line.setAttribute('y1',y1); line.setAttribute('x2',x2); line.setAttribute('y2',y2);
      line.setAttribute('stroke','var(--muted)'); line.setAttribute('stroke-width', i%5===0? 1.6:1);
      g.appendChild(line);
      if(i%2===0){ // etiquetas aproximadas
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        const rx = 110 + 76*Math.cos(angle*Math.PI/180);
        const ry = 120 + 76*Math.sin(angle*Math.PI/180);
        t.setAttribute('x', rx);
        t.setAttribute('y', ry+4);
        t.setAttribute('text-anchor','middle');
        t.textContent = String(Math.round((MAX/10)*i));
        t.setAttribute('fill','var(--muted)');
        t.setAttribute('font-size','11');
        g.appendChild(t);
      }
      ticksG.appendChild(g);
    }

    // ===== DOM refs =====
    const inputIdent = document.getElementById('ident');
    const inputAtrib = document.getElementById('atrib');
    const showIdent = document.getElementById('showIdent');
    const showAtrib = document.getElementById('showAtrib');
    const btnAplicar = document.getElementById('btnAplicar');
    const btnPDF = document.getElementById('btnPDF');
    const btnPNG = document.getElementById('btnPNG');

    const gaugeValue = document.getElementById('gaugeValue');
    const gaugeLabel = document.getElementById('gaugeLabel');
    const needle = document.getElementById('needle');
    const arcBase = document.getElementById('arcBase');
    const arcGreen = document.getElementById('arcGreen');
    const arcRed = document.getElementById('arcRed');

    // Fija strokes inline (para que export herede bien)
    arcGreen.setAttribute('stroke','url(#gradGreen)');
    arcRed.setAttribute('stroke','url(#gradRed)');
    (function(){
      const rs = getComputedStyle(document.documentElement);
      const ring = rs.getPropertyValue('--ring').trim() || '#e5e7eb';
      arcBase.setAttribute('stroke', ring);
    })();

    // ===== Core =====
    function setIdent(val){
      const v = clamp(val, 0, MAX);
      const ratio = v/MAX; // 0..1
      const rot = -90 + (ratio * 180);
      needle.setAttribute('transform', `rotate(${rot},110,120)`);
      showIdent.textContent = `${v} / ${MAX}`;
      return v;
    }

    function draw(identMax, atribMax){
      let L = 0; try{ L = arcBase.getTotalLength(); }catch(_){ L = 0; }
      if(!L || !isFinite(L)) L = 540; // fallback

      const pGreen = clamp(identMax,0,MAX)/MAX;                  // 0..1
      const pEnd   = Math.min(1, pGreen + clamp(atribMax,0,MAX)/MAX); // acumulado, tope 1
      const pRed   = Math.max(0, pEnd - pGreen);

      arcGreen.setAttribute('stroke-dasharray', `${(L*pGreen).toFixed(2)} ${(L*(1-pGreen)).toFixed(2)}`);
      arcGreen.setAttribute('stroke-dashoffset', `0`);
      arcRed.setAttribute('stroke-dasharray', `${(L*pRed).toFixed(2)} ${(L*(1-pRed)).toFixed(2)}`);
      arcRed.setAttribute('stroke-dashoffset', `${(-L*pGreen).toFixed(2)}`);
    }

    function updateCenterLabel(identMax, atribMax){
      const a = clamp(atribMax,0,MAX);
      const i = clamp(identMax,0,MAX);
      const pct = pctIdentSobreAtrib(i,a,true);
      gaugeValue.textContent = pct.toFixed(1);
      gaugeLabel.textContent = `% Identificados / Atribuciones ( ${i} / ${a} )`;
    }

    function update(){
      const vi = setIdent(inputIdent.value);
      const va = clamp(inputAtrib.value, 0, MAX);
      inputAtrib.value = va; showAtrib.textContent = `${va} / ${MAX}`;
      draw(vi, va);
      updateCenterLabel(vi, va);
    }

    // Eventos
    btnAplicar.addEventListener('click', update);
    inputIdent.addEventListener('input', update);
    inputAtrib.addEventListener('input', update);

    // ===== Exportar a PDF (iframe oculto) =====
    function buildPrintHTML(resolvedSVG){
      return `<!doctype html><html><head><meta charset="utf-8"><title>Export</title>
        <style>
          @page{ size: Letter portrait; margin:10mm }
          html,body{height:100%;}
          body{margin:0; display:flex; align-items:center; justify-content:center;}
          :root{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          svg{ width:90vw; height:auto; }
        </style>
      </head><body>${resolvedSVG}
      <script>window.addEventListener('load',()=>{ setTimeout(()=>{ window.print(); }, 150); });<\/script>
      </body></html>`;
    }

    function resolveSVGColorsForPrint(svgEl){
      var clone = svgEl.cloneNode(true);
      var rs = getComputedStyle(document.documentElement);
      function res(name, fb){ try{ var v = rs.getPropertyValue(name); return (v && v.trim()) || (fb||'#000'); }catch(_){ return fb||'#000'; } }
      // Gradientes
      clone.querySelectorAll('stop').forEach(function(st){
        var c = st.getAttribute('stop-color');
        if(c && c.indexOf('var(')===0){
          var n = c.slice(4,-1).trim(); st.setAttribute('stop-color', res(n));
        }
      });
      // fill/stroke con var(...)
      clone.querySelectorAll('*').forEach(function(el){
        ['fill','stroke'].forEach(function(attr){
          var v = el.getAttribute(attr);
          if(v && v.indexOf('var(')===0){ var n = v.slice(4,-1).trim(); el.setAttribute(attr, res(n)); }
        });
      });
      var ab = clone.getElementById('arcBase'); if(ab){ ab.setAttribute('stroke', res('--ring','#e5e7eb')); }
      clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
      clone.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
      return clone.outerHTML;
    }

    btnPDF.addEventListener('click', ()=>{
      try{
        const svg = document.getElementById('svgGauge');
        const resolved = resolveSVGColorsForPrint(svg);
        const html = buildPrintHTML(resolved);
        const iframe = document.createElement('iframe');
        Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'1px',height:'1px',opacity:'0',pointerEvents:'none'});
        document.body.appendChild(iframe);
        iframe.onload = ()=>{ try{ iframe.contentWindow.print(); }catch(_){} setTimeout(()=>{ try{ document.body.removeChild(iframe);}catch(_){} }, 800); };
        iframe.srcdoc = html;
      }catch(e){ console.error(e); alert('No se pudo preparar la exportación. Usa Ctrl+P.'); }
    });

    // ===== Resolver SVG para raster (PNG) =====
    function resolveSVGForRaster(svgEl){
      var clone = svgEl.cloneNode(true);
      var rs = getComputedStyle(document.documentElement);
      function res(name, fb){ try{ var v = rs.getPropertyValue(name); return (v && v.trim()) || (fb||'#000'); }catch(_){ return fb||'#000'; } }
      clone.querySelectorAll('stop').forEach(function(st){
        var c = st.getAttribute('stop-color');
        if(c && c.indexOf('var(')===0){ var n = c.slice(4,-1).trim(); st.setAttribute('stop-color', res(n)); }
      });
      clone.querySelectorAll('*').forEach(function(el){
        ['fill','stroke'].forEach(function(attr){ var v = el.getAttribute(attr); if(v && v.indexOf('var(')===0){ var n = v.slice(4,-1).trim(); el.setAttribute(attr, res(n)); } });
      });
      var ab = clone.getElementById('arcBase'); if(ab){ ab.setAttribute('stroke', res('--ring','#e5e7eb')); }
      clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
      clone.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
      clone.setAttribute('width','220');
      clone.setAttribute('height','140');
      return new XMLSerializer().serializeToString(clone);
    }

    // ===== Exportar PNG transparente (1280x720, centrado) =====
    function exportPNGTransparent(){
      var status = document.getElementById('exportStatus');
      var area = document.getElementById('downloadArea');
      function setStatus(html){ if(status){ status.innerHTML = html; } }
      try{
        var svgEl = document.getElementById('svgGauge');
        var svgText = resolveSVGForRaster(svgEl);

        // Lienzo rectangular 16:9 (ligero y compatible)
        var targetW = 1280, targetH = 720;
        var srcW = 220, srcH = 140; // dimensiones del SVG
        var s = Math.min(targetW/srcW, targetH/srcH);
        var drawW = Math.round(srcW*s), drawH = Math.round(srcH*s);
        var offsetX = Math.floor((targetW - drawW)/2);
        var offsetY = Math.floor((targetH - drawH)/2);

        var canvas = document.createElement('canvas');
        canvas.width = targetW; canvas.height = targetH;
        var ctx = canvas.getContext('2d');
        if(!ctx){ setStatus('Sin soporte de canvas.'); return; }
        if('imageSmoothingQuality' in ctx) ctx.imageSmoothingQuality = 'high';
        ctx.clearRect(0,0,targetW,targetH);

        // Carga el SVG como data URL persistente (no caduca como los Blob URL)
        var img = new Image();
        img.decoding = 'sync';
        img.onload = function(){
          try{
            ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
            // Genera DataURL PNG (transparente) y ofrece descarga + vista previa
            var data = canvas.toDataURL('image/png');

            if(area){
              area.innerHTML = '';
              var a = document.createElement('a');
              a.href = data; a.download = 'indicador-1280x720.png'; a.textContent = 'Descargar indicador-1280x720.png';
              a.target = '_blank';
              var btn = document.createElement('button');
              btn.className = 'secondary'; btn.style.marginLeft = '8px'; btn.textContent = 'Abrir en pestaña';
              btn.onclick = function(){ try{ window.open(data, '_blank'); }catch(_){} };
              var tip = document.createElement('div');
              tip.className = 'muted'; tip.style.margin = '6px 0';
              tip.textContent = 'Si no descarga: clic derecho sobre la imagen → "Guardar imagen como…"';
              var preview = document.createElement('img');
              preview.src = data; preview.alt = 'Vista previa PNG';
              preview.style.maxWidth = '420px'; preview.style.height = 'auto'; preview.style.background = 'transparent'; preview.style.display = 'block'; preview.style.marginTop = '6px';
              area.appendChild(a); area.appendChild(btn); area.appendChild(tip); area.appendChild(preview);
            }

            // Intento de descarga automática (puede estar bloqueado, por eso dejamos el enlace)
            try{ var auto = document.createElement('a'); auto.href = data; auto.download = 'indicador-1280x720.png'; document.body.appendChild(auto); auto.click(); document.body.removeChild(auto);}catch(_){ }
            setStatus('PNG generado.');
          }catch(e){ console.error(e); setStatus('Error al dibujar la imagen.'); }
        };
        img.onerror = function(){
          // Fallback a base64 si utf-8 falla
          try{
            var base64 = btoa(unescape(encodeURIComponent(svgText)));
            img.onerror = function(){ setStatus('No se pudo preparar el SVG para exportar.'); };
            img.src = 'data:image/svg+xml;base64,' + base64;
          }catch(e){ console.error(e); setStatus('No se pudo preparar el SVG para exportar.'); }
        };
        // Intento principal: data URL con charset estándar (persistente)
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgText);
        setStatus('Generando PNG…');
      }catch(e){ console.error(e); setStatus('Error inesperado al exportar PNG.'); }
    }
    btnPNG.addEventListener('click', exportPNGTransparent);

    // Inicio en cero
    update();

    // ===== Captura errores globales para mostrarlos en pantalla =====
    (function(){
      try{
        window.addEventListener('error', function(ev){
          var s = document.getElementById('exportStatus');
          if(s){ s.textContent = 'Error JS: ' + (ev && (ev.message || ev.error) || 'desconocido'); }
        });
      }catch(_){}
    })();
  </script>
</body>
</html>
